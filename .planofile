from skewer import *

@command(name="run")
def run_(app):
    build(app)

    with working_dir("order-processor"):
        order1 = start("python3 main.py")
        order2 = start("python3 main.py")

    with working_dir("market-data"):
        data1 = start("python3 main.py")

    with working_dir("frontend"):
        frontend1 = start("python3 main.py")

        with working_env(HTTP_PORT=8081):
            frontend2 = start("python3 main.py")

    try:
        while True:
            sleep(86400)
    finally:
        kill(order1)
        kill(order2)
        kill(data1)
        # kill(maker1)
        kill(frontend1)
        kill(frontend2)

@command
def build(app):
    for dir in ("frontend", "order-processor", "market-data"):
        copy("python/data.py", join(dir, "data.py"))

@command
def clean(app):
    for dir in find(".", "__pycache__"):
        remove(dir)

@command
def generate(app):
    """
    Generate README.md from the data in skewer.yaml
    """
    generate_readme("skewer.yaml", "README.md")

@command
def render(app):
    """
    Render README.html from the data in skewer.yaml
    """
    check_program("pandoc")

    generate(app)

    run(f"pandoc -o README.html README.md")

    print(f"file:{get_real_path('README.html')}")

@command
def test(app):
    generate_readme("skewer.yaml", make_temp_file())
    run_steps_on_minikube("skewer.yaml")

@command
def test_external(app, public_kubeconfig, private_kubeconfig):
    run_steps_external("skewer.yaml", public=public_kubeconfig, private=private_kubeconfig)

@command
def kafka_create_topics(app):
    run(f"~/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --topic orders --delete || :", shell=True)
    run(f"~/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --topic updates --delete || :", shell=True)
    run(f"~/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --topic orders --create --partitions 3", shell=True)
    run(f"~/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --topic updates --create --partitions 1", shell=True)
